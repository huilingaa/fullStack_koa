import{getErrorMessage,logMessage}from"./helpers";import{HistoryProvider}from"./history-provider";import{DataPulseProvider}from"./data-pulse-provider";import{QuotesPulseProvider}from"./quotes-pulse-provider";import{SymbolsStorage}from"./symbols-storage";function extractField(e,t,o){var r=e[t];return Array.isArray(r)?r[o]:r}var UDFCompatibleDatafeedBase=function(){function e(e,t,o,r){void 0===r&&(r=1e4);var s=this;this._configuration=defaultConfiguration(),this._symbolsStorage=null,this._datafeedURL=e,this._requester=o,this._historyProvider=new HistoryProvider(e,this._requester),this._quotesProvider=t,this._dataPulseProvider=new DataPulseProvider(this._historyProvider,r),this._quotesPulseProvider=new QuotesPulseProvider(this._quotesProvider),this._configurationReadyPromise=this._requestConfiguration().then((function(e){null===e&&(e=defaultConfiguration()),s._setupWithConfiguration(e)}))}return e.prototype.onReady=function(e){var t=this;this._configurationReadyPromise.then((function(){e(t._configuration)}))},e.prototype.getQuotes=function(e,t,o){this._quotesProvider.getQuotes(e).then(t).catch(o)},e.prototype.subscribeQuotes=function(e,t,o,r){this._quotesPulseProvider.subscribeQuotes(e,t,o,r)},e.prototype.unsubscribeQuotes=function(e){this._quotesPulseProvider.unsubscribeQuotes(e)},e.prototype.calculateHistoryDepth=function(e,t,o){},e.prototype.getMarks=function(e,t,o,r,s){if(this._configuration.supports_marks){var i={symbol:e.ticker||"",from:t,to:o,resolution:s};this._send("marks",i).then((function(e){if(!Array.isArray(e)){for(var t=[],o=0;o<e.id.length;++o)t.push({id:extractField(e,"id",o),time:extractField(e,"time",o),color:extractField(e,"color",o),text:extractField(e,"text",o),label:extractField(e,"label",o),labelFontColor:extractField(e,"labelFontColor",o),minSize:extractField(e,"minSize",o)});e=t}r(e)})).catch((function(e){logMessage("UdfCompatibleDatafeed: Request marks failed: "+getErrorMessage(e)),r([])}))}},e.prototype.getTimescaleMarks=function(e,t,o,r,s){if(this._configuration.supports_timescale_marks){var i={symbol:e.ticker||"",from:t,to:o,resolution:s};this._send("timescale_marks",i).then((function(e){if(!Array.isArray(e)){for(var t=[],o=0;o<e.id.length;++o)t.push({id:extractField(e,"id",o),time:extractField(e,"time",o),color:extractField(e,"color",o),label:extractField(e,"label",o),tooltip:extractField(e,"tooltip",o)});e=t}r(e)})).catch((function(e){logMessage("UdfCompatibleDatafeed: Request timescale marks failed: "+getErrorMessage(e)),r([])}))}},e.prototype.getServerTime=function(e){this._configuration.supports_time&&this._send("time").then((function(t){var o=parseInt(t);isNaN(o)||e(o)})).catch((function(e){logMessage("UdfCompatibleDatafeed: Fail to load server time, error="+getErrorMessage(e))}))},e.prototype.searchSymbols=function(e,t,o,r){if(this._configuration.supports_search){var s={limit:30,query:e.toUpperCase(),type:o,exchange:t};this._send("search",s).then((function(e){if(void 0!==e.s)return logMessage("UdfCompatibleDatafeed: search symbols error="+e.errmsg),void r([]);r(e)})).catch((function(t){logMessage("UdfCompatibleDatafeed: Search symbols for '"+e+"' failed. Error="+getErrorMessage(t)),r([])}))}else{if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.searchSymbols(e,t,o,30).then(r).catch(r.bind(null,[]))}},e.prototype.resolveSymbol=function(e,t,o){logMessage("Resolve requested");var r=Date.now();function s(e){logMessage("Symbol resolved: "+(Date.now()-r)+"ms"),t(e)}if(this._configuration.supports_group_request){if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.resolveSymbol(e).then(s).catch(o)}else{var i={symbol:e};this._send("symbols",i).then((function(e){void 0!==e.s?o("unknown_symbol"):s(e)})).catch((function(e){logMessage("UdfCompatibleDatafeed: Error resolving symbol: "+getErrorMessage(e)),o("unknown_symbol")}))}},e.prototype.getBars=function(e,t,o,r,s,i){this._historyProvider.getBars(e,t,o,r).then((function(e){s(e.bars,e.meta)})).catch(i)},e.prototype.subscribeBars=function(e,t,o,r,s){this._dataPulseProvider.subscribeBars(e,t,o,r)},e.prototype.unsubscribeBars=function(e){this._dataPulseProvider.unsubscribeBars(e)},e.prototype._requestConfiguration=function(){return this._send("config").catch((function(e){return logMessage("UdfCompatibleDatafeed: Cannot get datafeed configuration - use default, error="+getErrorMessage(e)),null}))},e.prototype._send=function(e,t){return this._requester.sendRequest(this._datafeedURL,e,t)},e.prototype._setupWithConfiguration=function(e){if(this._configuration=e,void 0===e.exchanges&&(e.exchanges=[]),!e.supports_search&&!e.supports_group_request)throw new Error("Unsupported datafeed configuration. Must either support search, or support group request");!e.supports_group_request&&e.supports_search||(this._symbolsStorage=new SymbolsStorage(this._datafeedURL,e.supported_resolutions||[],this._requester)),logMessage("UdfCompatibleDatafeed: Initialized with "+JSON.stringify(e))},e}();export{UDFCompatibleDatafeedBase};function defaultConfiguration(){return{supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1}}