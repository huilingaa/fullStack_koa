import{getErrorMessage,logMessage}from"./helpers";function extractField(e,t,r){var i=e[t];return Array.isArray(i)?i[r]:i}var SymbolsStorage=function(){function e(e,t,r){this._exchangesList=["NYSE","FOREX","AMEX"],this._symbolsInfo={},this._symbolsList=[],this._datafeedUrl=e,this._datafeedSupportedResolutions=t,this._requester=r,this._readyPromise=this._init(),this._readyPromise.catch((function(e){console.error("SymbolsStorage: Cannot init, error="+e.toString())}))}return e.prototype.resolveSymbol=function(e){var t=this;return this._readyPromise.then((function(){var r=t._symbolsInfo[e];return void 0===r?Promise.reject("invalid symbol"):Promise.resolve(r)}))},e.prototype.searchSymbols=function(e,t,r,i){var o=this;return this._readyPromise.then((function(){var a=[],n=0===e.length;e=e.toUpperCase();for(var s=function(i){var s=o._symbolsInfo[i];if(void 0===s)return"continue";if(r.length>0&&s.type!==r)return"continue";if(t&&t.length>0&&s.exchange!==t)return"continue";var l=s.name.toUpperCase().indexOf(e),c=s.description.toUpperCase().indexOf(e);if((n||l>=0||c>=0)&&!a.some((function(e){return e.symbolInfo===s}))){var d=l>=0?l:8e3+c;a.push({symbolInfo:s,weight:d})}},l=0,c=o._symbolsList;l<c.length;l++){s(c[l])}var d=a.sort((function(e,t){return e.weight-t.weight})).slice(0,i).map((function(e){var t=e.symbolInfo;return{symbol:t.name,full_name:t.full_name,description:t.description,exchange:t.exchange,params:[],type:t.type,ticker:t.name}}));return Promise.resolve(d)}))},e.prototype._init=function(){for(var e=this,t=[],r={},i=0,o=this._exchangesList;i<o.length;i++){var a=o[i];r[a]||(r[a]=!0,t.push(this._requestExchangeData(a)))}return Promise.all(t).then((function(){e._symbolsList.sort(),logMessage("SymbolsStorage: All exchanges data loaded")}))},e.prototype._requestExchangeData=function(e){var t=this;return new Promise((function(r,i){t._requester.sendRequest(t._datafeedUrl,"symbol_info",{group:e}).then((function(o){try{t._onExchangeDataReceived(e,o)}catch(e){return void i(e)}r()})).catch((function(t){logMessage("SymbolsStorage: Request data for exchange '"+e+"' failed, reason="+getErrorMessage(t)),r()}))}))},e.prototype._onExchangeDataReceived=function(e,t){var r=0;try{for(var i=t.symbol.length,o=void 0!==t.ticker;r<i;++r){var a=t.symbol[r],n=extractField(t,"exchange-listed",r),s=extractField(t,"exchange-traded",r),l=s+":"+a,c=o?extractField(t,"ticker",r):a,d={ticker:c,name:a,base_name:[n+":"+a],full_name:l,listed_exchange:n,exchange:s,description:extractField(t,"description",r),has_intraday:definedValueOrDefault(extractField(t,"has-intraday",r),!1),has_no_volume:definedValueOrDefault(extractField(t,"has-no-volume",r),!1),minmov:extractField(t,"minmovement",r)||extractField(t,"minmov",r)||0,minmove2:extractField(t,"minmove2",r)||extractField(t,"minmov2",r),fractional:extractField(t,"fractional",r),pricescale:extractField(t,"pricescale",r),type:extractField(t,"type",r),session:extractField(t,"session-regular",r),timezone:extractField(t,"timezone",r),supported_resolutions:definedValueOrDefault(extractField(t,"supported-resolutions",r),this._datafeedSupportedResolutions),force_session_rebuild:extractField(t,"force-session-rebuild",r),has_daily:definedValueOrDefault(extractField(t,"has-daily",r),!0),intraday_multipliers:definedValueOrDefault(extractField(t,"intraday-multipliers",r),["1","5","15","30","60"]),has_weekly_and_monthly:extractField(t,"has-weekly-and-monthly",r),has_empty_bars:extractField(t,"has-empty-bars",r),volume_precision:definedValueOrDefault(extractField(t,"volume-precision",r),0)};this._symbolsInfo[c]=d,this._symbolsInfo[a]=d,this._symbolsInfo[l]=d,this._symbolsList.push(a)}}catch(i){throw new Error("SymbolsStorage: API error when processing exchange "+e+" symbol #"+r+" ("+t.symbol[r]+"): "+i.message)}},e}();export{SymbolsStorage};function definedValueOrDefault(e,t){return void 0!==e?e:t}